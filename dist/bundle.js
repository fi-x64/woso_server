(()=>{var e={574:(e,t,a)=>{const s=a(252),o=(a(96),a(525)),r=a(738),n=a(900),i=a(577),d=a(492),c=a(105),l=a(67),u=a(35),h=s();h.use(i()),h.use(o()),h.use(s.json({limit:"10kb"})),h.use(r()),h.use(n({whitelist:["duration","ratingsQuantity","ratingsAverage","maxGroupSize","difficulty","price"]})),h.use(s.static(`${__dirname}/public`)),h.use(((e,t,a)=>{e.requestTime=(new Date).toISOString(),a()})),h.use("/api/user",l),h.use("/api/batch",u),h.all("*",((e,t,a)=>{a(new d(`Can't find ${e.originalUrl} on this server!`,404))})),h.use(c),e.exports=h},617:(e,t,a)=>{const s=a(982),{promisify:o}=a(23),r=a(829),n=a(760),i=a(702),d=a(492),c=a(729),{Sequelize:l}=a(31),u=n.userModel,h=n.roleModel,p=(e,t,a)=>{const s=(o=e.id,r.sign({id:o},"SuperSecretKeyInJWT",{expiresIn:"60"}));var o;const n={expires:new Date(Date.now()+5184e6),httpOnly:!0,secure:!0};a.cookie("jwt",s,n),e.password=void 0,a.status(t).json({status:"success",token:s,data:e})},w=async(e,t)=>await c.compare(e,t);t.signup=i((async(e,t,a)=>{if(await u.findOne({where:{[l.Op.or]:[{email:e.body.email}]}}))t.status(200).json({status:"fail",message:"Email has existed"});else{const a=await c.hash(e.body.password,12);await u.create({username:e.body.username,email:e.body.email,password:a})&&t.status(200).json({status:"success",message:"Account created successfully"})}})),t.login=i((async(e,t,a)=>{const{email:s,password:o}=e.body;s&&o||t.status(200).json({status:"error",message:"Email not exists"});const r=await u.findOne({where:{email:s},include:{model:h,raw:!0}});if(!r||!await w(o,r.password))return a(new d("Email or password is incorrect",401));p(r,200,t)})),t.protect=i((async(e,t,a)=>{let s;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer")&&(s=e.headers.authorization.split(" ")[1]),!s)return a(new d("You are not logged in! Please login to get access.",401));const n=await o(r.verify)(s,"SuperSecretKeyInJWT"),i=await u.findById(n.id);return i?i.changedPasswordAfter(n.iat)?a(new d("User recently changed password! Please login again.",401)):(e.user=i,void a()):a(new d("Token is expired. Please login again",401))})),t.restrictTo=(...e)=>(t,a,s)=>{if(!e.includes(t.user.quyen.ten))return s(new d("You do not have permission to perform this action",403));s()},t.createOTP=i((async(e,t,a)=>{const s=await u.findOne({email:e.body.email});return s?s?(s.otp=void 0,s.hanDatLaiOTP=void 0,s.trangThai=!0,await s.save(),void t.status(200).json({status:"success",message:"Đã kích hoạt tài khoản thành công!"})):a(new d("OTP không đúng hoặc đã hết hạn",400)):a(new d("Không tìm thấy người dùng với email này trên hệ thống.",404))})),t.updatePassword=i((async(e,t,a)=>{if(!(s=await u.findById(e.user.id).select("+matKhau")))var s=await u.findById(e.user.id);if(s.matKhau&&!await w(e.body.passwordCurrent,s.matKhau))return t.status(200).json({status:"error",message:"Mật khẩu hiện tại không đúng!"});s.matKhau=e.body.password,s.xacNhanMatKhau=e.body.passwordConfirm,await s.save(),p(s,200,t)})),t.validateToken=i((async(e,t,a)=>{const o=s.createHash("sha256").update(e.query.token).digest("hex");return await u.findOne({tokenDatLaiMatKhau:o,hanDatLaiMatKhau:{$gt:Date.now()}})?t.status(200).json({status:"success",message:"Token hợp lệ!"}):t.status(200).json({status:"error",message:"Token không đúng hoặc đã hết hạn!"})})),t.resetPassword=i((async(e,t,a)=>{const o=s.createHash("sha256").update(e.body.token).digest("hex"),r=await u.findOne({tokenDatLaiMatKhau:o,hanDatLaiMatKhau:{$gt:Date.now()}});return r?(r.matKhau=e.body.password,r.xacNhanMatKhau=e.body.confirmPassword,r.tokenDatLaiMatKhau=void 0,r.hanDatLaiMatKhau=void 0,await r.save(),t.status(200).json({status:"success",message:"Đã đặt lại mật khẩu thành công!"})):t.status(200).json({status:"error",message:"Token không đúng hoặc đã hết hạn!"})}))},351:(e,t,a)=>{const s=a(760),o=a(702),{Sequelize:r,Op:n}=(a(492),a(31)),i=s.batchModel;t.getBatch=o((async(e,t,a)=>{const s=e.params.batchCode,o=await i.findOne({where:{batch_code:{[n.like]:`${s}`}}});return o?t.status(200).json({status:"success",data:o}):t.status(500).json({status:"error",data:"Get batch failed"})})),t.getAllBatch=o((async(e,t,a)=>{let s;if(e.body.keyword){const t=e.body.keyword;if(e.body.dateShipFilter.length>0&&e.body.dateExpFilter.length>0){const a=e.body.dateShipFilter,o=e.body.dateExpFilter;s=await i.findAll({where:{[n.and]:[{date_of_shipment:{[n.between]:[a[0],a[1]]}},{expiration_date:{[n.between]:[o[0],o[1]]}},{[n.or]:[{batch_code:{[n.like]:`%${t}%`}},{product_origin:{[n.like]:`%${t}%`}},{country_of_destination:{[n.like]:`%${t}%`}},{test_report_link_name:{[n.like]:`%${t}%`}}]}]},order:[["id","desc"]]})}else if(e.body.dateShipFilter.length>0){const a=e.body.dateShipFilter;s=await i.findAll({where:{[n.and]:[{date_of_shipment:{[n.between]:[a[0],a[1]]}},{[n.or]:[{batch_code:{[n.like]:`%${t}%`}},{product_origin:{[n.like]:`%${t}%`}},{country_of_destination:{[n.like]:`%${t}%`}},{test_report_link_name:{[n.like]:`%${t}%`}}]}]},order:[["id","desc"]]})}else if(e.body.dateExpFilter.length>0){const a=e.body.dateExpFilter;s=await i.findAll({where:{[n.and]:[{expiration_date:{[n.between]:[a[0],a[1]]}},{[n.or]:[{batch_code:{[n.like]:`%${t}%`}},{product_origin:{[n.like]:`%${t}%`}},{country_of_destination:{[n.like]:`%${t}%`}},{test_report_link_name:{[n.like]:`%${t}%`}}]}]},order:[["id","desc"]]})}else s=await i.findAll({where:{[n.or]:[{batch_code:{[n.like]:`%${t}%`}},{product_origin:{[n.like]:`%${t}%`}},{country_of_destination:{[n.like]:`%${t}%`}},{test_report_link_name:{[n.like]:`%${t}%`}}]},order:[["id","desc"]]})}else if(e.body.dateShipFilter.length>0&&e.body.dateExpFilter.length>0){const t=e.body.dateShipFilter,a=e.body.dateExpFilter;s=await i.findAll({where:{[n.and]:[{date_of_shipment:{[n.between]:[t[0],t[1]]}},{expiration_date:{[n.between]:[a[0],a[1]]}}]},order:[["id","desc"]]})}else if(e.body.dateShipFilter.length>0){const t=e.body.dateShipFilter;s=await i.findAll({where:{date_of_shipment:{[n.between]:[t[0],t[1]]}},order:[["id","desc"]]})}else if(e.body.dateExpFilter.length>0){const t=e.body.dateExpFilter;s=await i.findAll({where:{expiration_date:{[n.between]:[t[0],t[1]]}},order:[["id","desc"]]})}else s=await i.findAll({order:[["id","desc"]]});return s?t.status(200).json({status:"success",data:s}):t.status(500).json({status:"error",data:"Get all batch failed"})})),t.createBatch=o((async(e,t,a)=>{const s=e.body;var o;const r=await i.findOne({where:{batch_code:s.batchCode}});if(!r){const e=new i({batch_code:s.batchCode,product_origin:s.productOrigin,country_of_destination:s.countryOfDestination,date_of_shipment:s.dateOfShipment,expiration_date:s.expirationDate,test_report_link_name:s.testReportLinkName,test_report:s.testReport});o=await e.save()}o?t.status(200).json({status:"success",data:`Created batch ${s.batchCode} successfully`}):r?t.status(200).json({status:"error",data:`Batch ${s.batchCode} already exists`}):t.status(500).json({status:"error",data:`Create batch ${s.batchCode} failed`})})),t.editBatch=o((async(e,t,a)=>{const s=e.body;let o=await i.findOne({where:{batch_code:s.prevBatchCode}});if(!o)return t.status(500).json({status:"error",data:`Batch ${s.batchCode} not exists`});await o.update({...o.dataValues,batch_code:s.batchCode,product_origin:s.productOrigin,country_of_destination:s.countryOfDestination,date_of_shipment:s.dateOfShipment,expiration_date:s.expirationDate,test_report_link_name:s.testReportLinkName,test_report:s.testReport})?t.status(200).json({status:"success",data:`Edit batch ${s.batchCode} successfully`}):t.status(500).json({status:"error",data:`Edit batch ${s.batchCode} failed`})})),t.deleteBatch=o((async(e,t,a)=>{const s=e.params;await i.destroy({where:{batch_code:s.batchCode}})?t.status(200).json({status:"success",data:`Delete batch ${s.batchCode} successfully`}):t.status(500).json({status:"error",data:`Delete batch ${s.batchCode} failed`})}))},105:(e,t,a)=>{const s=a(492);e.exports=(e,t,a,o)=>{e.statusCode=e.statusCode||500,e.status=e.status||"error";{let t={...e};"CastError"===t.name&&(t=(e=>{const t=`Invalid ${e.path}: ${e.value}.`;return new s(t,400)})(t)),11e3===t.code&&(t=(e=>{const t=e.errmsg.match(/(["'])(\\?.)*?\1/)[0];return console.log(t),new s(`Duplicate field value: ${t}. Please use another value!`,400)})(t)),"ValidationError"===t.name&&(t=(e=>{const t=`Invalid input data. ${Object.values(e.errors).map((e=>e.message)).join(". ")}`;return new s(t,400)})(t)),"JsonWebTokenError"===t.name&&(t=new s("Invalid token. Please log in again!",401)),"TokenExpiredError"===t.name&&(t=new s("Your token has expired! Please log in again.",401)),((e,t)=>{e.isOperational?t.status(e.statusCode).json({status:e.status,message:e.message}):(console.error("ERROR 💥",e),t.status(500).json({status:"error",message:"Something went very wrong!"}))})(t,a)}}},295:e=>{e.exports=(e,t)=>e.define("batchs",{batch_code:{allowNull:!1,type:t.STRING,unique:!0},product_origin:{allowNull:!1,type:t.STRING,unique:!0},country_of_destination:{allowNull:!1,type:t.STRING,unique:!0},date_of_shipment:{allowNull:!1,type:t.DATE},expiration_date:{allowNull:!1,type:t.DATE},test_report:{allowNull:!1,type:t.STRING},test_report_link_name:{allowNull:!1,type:t.STRING}},{createdAt:"created_at",updatedAt:"updated_at",deletedAt:"deleted_at",tableName:"batchs"})},760:(e,t,a)=>{const{Sequelize:s,DataTypes:o}=a(31);a(818).config();const r=new s("thetruenest_db","root","root",{host:"127.0.0.1",dialect:"mysql",operatorsAliases:0,timezone:"+07:00"});r.authenticate().then((()=>{console.log("Database connected..")})).catch((e=>{console.log("Error"+e)}));const n={};n.Sequelize=s,n.sequelize=r,n.userModel=a(596)(r,o),n.roleModel=a(817)(r,o),n.batchModel=a(295)(r,o),n.userModel.belongsTo(n.roleModel,{foreignKey:"role_id"}),e.exports=n},817:e=>{e.exports=(e,t)=>e.define("roles",{name:{allowNull:!1,type:t.STRING},description:{allowNull:!1,type:t.STRING,unique:!0}},{createdAt:"created_at",updatedAt:"updated_at",deletedAt:"deleted_at",tableName:"roles"})},596:e=>{e.exports=(e,t)=>e.define("users",{username:{allowNull:!1,type:t.STRING},email:{allowNull:!1,type:t.STRING,unique:!0},role_id:{allowNull:!1,type:t.NUMBER},password:{allowNull:!1,type:t.STRING}},{createdAt:"created_at",updatedAt:"updated_at",deletedAt:"deleted_at",tableName:"users"})},35:(e,t,a)=>{const s=a(252),o=a(351),r=s.Router();r.get("/getBatch/:batchCode",o.getBatch),r.post("/getAllBatch",o.getAllBatch),r.post("/createBatch",o.createBatch),r.post("/editBatch",o.editBatch),r.delete("/deleteBatch/:batchCode",o.deleteBatch),e.exports=r},67:(e,t,a)=>{const s=a(252),o=a(617),r=s.Router();r.post("/signup",o.signup),r.post("/login",o.login),r.get("/validateToken",o.validateToken),r.patch("/resetPassword",o.resetPassword),e.exports=r},492:e=>{class t extends Error{constructor(e,t){super(e),this.statusCode=t,this.status=`${t}`.startsWith("4")?"fail":"error",this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}}e.exports=t},702:e=>{e.exports=e=>(t,a,s)=>{e(t,a,s).catch(s)}},729:e=>{"use strict";e.exports=require("bcryptjs")},577:e=>{"use strict";e.exports=require("cors")},818:e=>{"use strict";e.exports=require("dotenv")},252:e=>{"use strict";e.exports=require("express")},525:e=>{"use strict";e.exports=require("helmet")},900:e=>{"use strict";e.exports=require("hpp")},57:e=>{"use strict";e.exports=require("https")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},96:e=>{"use strict";e.exports=require("morgan")},31:e=>{"use strict";e.exports=require("sequelize")},738:e=>{"use strict";e.exports=require("xss-clean")},982:e=>{"use strict";e.exports=require("crypto")},896:e=>{"use strict";e.exports=require("fs")},23:e=>{"use strict";e.exports=require("util")}},t={};function a(s){var o=t[s];if(void 0!==o)return o.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,a),r.exports}const s=a(818),{Sequelize:o,DataTypes:r}=a(31);a(57),a(896),process.on("uncaughtException",(e=>{console.log("UNCAUGHT EXCEPTION! 💥 Shutting down..."),console.log(e.name,e.message),process.exit(1)})),s.config({path:".env"});const n=a(574),i="3000",d=n.listen(i,(()=>{console.log(`App running on port ${i}...`)}));process.on("unhandledRejection",(e=>{console.log("UNHANDLED REJECTION! 💥 Shutting down..."),console.log(e.name,e.message),d.close((()=>{process.exit(1)}))}))})();